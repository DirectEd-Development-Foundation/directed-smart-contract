import {
  Data,
  Constr,
  Lucid,
  Blockfrost,
  getAddressDetails,
  MintingPolicy,
  TxHash,
  UTxO,
  Address,
  AddressDetails,
  Unit,
  PolicyId,
  SpendingValidator,
} from "https://deno.land/x/lucid@0.10.6/mod.ts"

import { secretSeed } from "./seed.ts"

// set blockfrost endpoint (add your own Blockfrost key here)
const lucid = await Lucid.new(
    new Blockfrost(
      "https://cardano-preview.blockfrost.io/api/v0",
      "previewRotaZGxMOMhVbiBSAciY5fRcPllSBJ8T"
    ),
    "Preview"
  );

// load local stored seed into lucid and read out 5 addresses (in order to test the full flow, in reality these addresses will belong to different parties).
lucid.selectWalletFromSeed(secretSeed, { accountIndex: 0 });
const addr0: Address = await lucid.wallet.address();
console.log("Address for wallet 0 (Authority): " + addr0);
lucid.selectWalletFromSeed(secretSeed, { accountIndex: 1 });
const addr1: Address = await lucid.wallet.address();
console.log("Address for wallet 1 (School): " + addr1);
lucid.selectWalletFromSeed(secretSeed, { accountIndex: 2 });
const addr2: Address = await lucid.wallet.address();
console.log("Address for wallet 2 (CP):: " + addr2);
lucid.selectWalletFromSeed(secretSeed, { accountIndex: 3 });
const addr3: Address = await lucid.wallet.address();
console.log("Address for wallet 3 (Donor):: " + addr3);
lucid.selectWalletFromSeed(secretSeed, { accountIndex: 4 });
const addr4: Address = await lucid.wallet.address();
console.log("Address for wallet 4 (Student):: " + addr4);

// get the pubkeyhashes (used with cabal exec writeScripts to generate script Addresses currently)
const details0: AddressDetails = getAddressDetails(addr0);
const PKH0: string = details0.paymentCredential.hash
console.log("PKH for wallet 0 (Authority): " + PKH0);
const details1: AddressDetails = getAddressDetails(addr1);
const PKH1: string = details1.paymentCredential.hash
console.log("PKH for wallet 1 (School): " + PKH1);
const details2: AddressDetails = getAddressDetails(addr2);
const PKH2: string = details2.paymentCredential.hash
console.log("PKH for wallet 2 (CP): " + PKH2);
const details3: AddressDetails = getAddressDetails(addr3);
const PKH3: string = details3.paymentCredential.hash
console.log("PKH for wallet 3 (Donor): " + PKH3);
const details4: AddressDetails = getAddressDetails(addr4);
const PKH4: string = details4.paymentCredential.hash
console.log("PKH for wallet 4 (Student): " + PKH4);

// Define the acceptanceToken plutus script
const acceptanceTokenScript: MintingPolicy = {
  type: "PlutusV2",
  script: "590a37590a340100003323322332232323232323232323232323232332232323232323232323232222323253353232323233355300b120013233500d223335003220020020013500122001123300122533500210011028027235001223225335333573466e20005200002b02a102b15335333573466e24005200002a02b1533553353235001222222222222533533355301d12001501c25335333573466e3c0700040e40e04d40a00045409c010840e440dd401c40ac4cd5ce2481196e6f74207369676e656420627920696e737469747574696f6e0002a153355335533533355301012001500f25335333573466e24c8c8c8c00400cc8004d540bc88cd400520002235002225335333573466e3c00801c0d00cc4c02c0044c01800d4020d4004888800d200002b02c13501b0011501a35500722222222222200a21353500122220042233500223501e0012501d1501921333573466e3c0100040b00ac40a840ac4cd5ce24811a6d7573742073656e6420746f2073706563696669656420706b680002a102a102a3200135502a223350014800088d4008894cd4ccd5cd19b8f00200702f02e10011300600333355300d120012253353500222232333573466e3c0100040b00ad40184cd409400800440054090c8cc0894094004d540088888888888880204d4cccd4d40088800498848c004008989880044d400488008cccd5cd19b8735573aa0069000119910919800801801191919191919191919191919191999ab9a3370e6aae754031200023333333333332222222222221233333333333300100d00c00b00a00900800700600500400300233501a01b35742a01866a0340366ae85402ccd4068070d5d0a805199aa80f3ae501d35742a012666aa03ceb94074d5d0a80419a80d0129aba150073335501e02675a6ae854018c8c8c8cccd5cd19b8735573aa00490001199109198008018011919191999ab9a3370e6aae754009200023322123300100300233503075a6ae854008c0c4d5d09aba2500223263203333573806806606226aae7940044dd50009aba150023232323333573466e1cd55cea8012400046644246600200600466a060eb4d5d0a80118189aba135744a004464c6406666ae700d00cc0c44d55cf280089baa001357426ae8940088c98c80bccd5ce01801781689aab9e5001137540026ae854014cd4069d71aba150043335501e022200135742a006666aa03ceb88004d5d0a80118121aba135744a004464c6405666ae700b00ac0a44d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a801980a1aba135744a006464c6403a66ae7007807406ccccd5cd19b8735573a6ea80112000201c23263201c33573803a0380342036264c6403666ae712401035054350001b135573ca00226ea80044cd4008894cd40088400c40054028c8004d5407088448894cd40044d400c88004884ccd401488008c010008ccd54c01c4800401401000448848cc00400c008c8004d5406888448894cd40044008884cc014008ccd54c01c4800401401000448c88c008dd6000990009aa80d111999aab9f0012501a233501930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500d014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355017223233335573e0044a030466a02e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200224464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900919ab9c01301201000f135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200c23333573466e1d40092000200c23263200633573800e00c00800626aae74dd5000a4c240029201035054310032001355006222533500110022213500222330073330080020060010033200135500522225335001100222135002225335333573466e1c005200000c00b1333008007006003133300800733500912333001008003002006003112200212212233001004003122002122001112323001001223300330020020014891c85d9efa7117df5a2c8acf8152fa74904344e022f06a3f26d48b0280e0001",
};
const acceptanceTokenAddress: Address = lucid.utils.validatorToAddress(acceptanceTokenScript);
const acceptanceTokenPolicyID: PolicyId = lucid.utils.mintingPolicyToId(acceptanceTokenScript);

// Define the studentToken plutus script
const studentTokenScript: MintingPolicy = {
  type: "PlutusV2",
  script: "590a37590a340100003323322332232323232323232323232323232332232323232323232323232222323253353232323233355300b120013233500d223335003220020020013500122001123300122533500210011028027235001223225335333573466e20005200002b02a102b15335333573466e24005200002a02b1533553353235001222222222222533533355301d12001501c25335333573466e3c0700040e40e04d40a00045409c010840e440dd401c40ac4cd5ce2481196e6f74207369676e656420627920696e737469747574696f6e0002a153355335533533355301012001500f25335333573466e24c8c8c8c00400cc8004d540bc88cd400520002235002225335333573466e3c00801c0d00cc4c02c0044c01800d4020d4004888800d200002b02c13501b0011501a35500722222222222200a21353500122220042233500223501e0012501d1501921333573466e3c0100040b00ac40a840ac4cd5ce24811a6d7573742073656e6420746f2073706563696669656420706b680002a102a102a3200135502a223350014800088d4008894cd4ccd5cd19b8f00200702f02e10011300600333355300d120012253353500222232333573466e3c0100040b00ad40184cd409400800440054090c8cc0894094004d540088888888888880204d4cccd4d40088800498848c004008989880044d400488008cccd5cd19b8735573aa0069000119910919800801801191919191919191919191919191999ab9a3370e6aae754031200023333333333332222222222221233333333333300100d00c00b00a00900800700600500400300233501a01b35742a01866a0340366ae85402ccd4068070d5d0a805199aa80f3ae501d35742a012666aa03ceb94074d5d0a80419a80d0129aba150073335501e02675a6ae854018c8c8c8cccd5cd19b8735573aa00490001199109198008018011919191999ab9a3370e6aae754009200023322123300100300233503075a6ae854008c0c4d5d09aba2500223263203333573806806606226aae7940044dd50009aba150023232323333573466e1cd55cea8012400046644246600200600466a060eb4d5d0a80118189aba135744a004464c6406666ae700d00cc0c44d55cf280089baa001357426ae8940088c98c80bccd5ce01801781689aab9e5001137540026ae854014cd4069d71aba150043335501e022200135742a006666aa03ceb88004d5d0a80118121aba135744a004464c6405666ae700b00ac0a44d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a801980a1aba135744a006464c6403a66ae7007807406ccccd5cd19b8735573a6ea80112000201c23263201c33573803a0380342036264c6403666ae712401035054350001b135573ca00226ea80044cd4008894cd40088400c40054028c8004d5407088448894cd40044d400c88004884ccd401488008c010008ccd54c01c4800401401000448848cc00400c008c8004d5406888448894cd40044008884cc014008ccd54c01c4800401401000448c88c008dd6000990009aa80d111999aab9f0012501a233501930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500d014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355017223233335573e0044a030466a02e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200224464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900919ab9c01301201000f135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200c23333573466e1d40092000200c23263200633573800e00c00800626aae74dd5000a4c240029201035054310032001355006222533500110022213500222330073330080020060010033200135500522225335001100222135002225335333573466e1c005200000c00b1333008007006003133300800733500912333001008003002006003112200212212233001004003122002122001112323001001223300330020020014891c12cffb45b4187c7d2c7c650e4907300cb7aaf292556145e0773ad0530001",
};
const studentTokenAddress: Address = lucid.utils.validatorToAddress(studentTokenScript);
const studentTokenPolicyID: PolicyId = lucid.utils.mintingPolicyToId(studentTokenScript);

// Define the MilestoneToken plutus script
const MilestoneTokenScript: MintingPolicy = {
  type: "PlutusV2",
  script: "590a37590a340100003323322332232323232323232323232323232332232323232323232323232222323253353232323233355300b120013233500d223335003220020020013500122001123300122533500210011028027235001223225335333573466e20005200002b02a102b15335333573466e24005200002a02b1533553353235001222222222222533533355301d12001501c25335333573466e3c0700040e40e04d40a00045409c010840e440dd401c40ac4cd5ce2481196e6f74207369676e656420627920696e737469747574696f6e0002a153355335533533355301012001500f25335333573466e24c8c8c8c00400cc8004d540bc88cd400520002235002225335333573466e3c00801c0d00cc4c02c0044c01800d4020d4004888800d200002b02c13501b0011501a35500722222222222200a21353500122220042233500223501e0012501d1501921333573466e3c0100040b00ac40a840ac4cd5ce24811a6d7573742073656e6420746f2073706563696669656420706b680002a102a102a3200135502a223350014800088d4008894cd4ccd5cd19b8f00200702f02e10011300600333355300d120012253353500222232333573466e3c0100040b00ad40184cd409400800440054090c8cc0894094004d540088888888888880204d4cccd4d40088800498848c004008989880044d400488008cccd5cd19b8735573aa0069000119910919800801801191919191919191919191919191999ab9a3370e6aae754031200023333333333332222222222221233333333333300100d00c00b00a00900800700600500400300233501a01b35742a01866a0340366ae85402ccd4068070d5d0a805199aa80f3ae501d35742a012666aa03ceb94074d5d0a80419a80d0129aba150073335501e02675a6ae854018c8c8c8cccd5cd19b8735573aa00490001199109198008018011919191999ab9a3370e6aae754009200023322123300100300233503075a6ae854008c0c4d5d09aba2500223263203333573806806606226aae7940044dd50009aba150023232323333573466e1cd55cea8012400046644246600200600466a060eb4d5d0a80118189aba135744a004464c6406666ae700d00cc0c44d55cf280089baa001357426ae8940088c98c80bccd5ce01801781689aab9e5001137540026ae854014cd4069d71aba150043335501e022200135742a006666aa03ceb88004d5d0a80118121aba135744a004464c6405666ae700b00ac0a44d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea8004d5d0a801980a1aba135744a006464c6403a66ae7007807406ccccd5cd19b8735573a6ea80112000201c23263201c33573803a0380342036264c6403666ae712401035054350001b135573ca00226ea80044cd4008894cd40088400c40054028c8004d5407088448894cd40044d400c88004884ccd401488008c010008ccd54c01c4800401401000448848cc00400c008c8004d5406888448894cd40044008884cc014008ccd54c01c4800401401000448c88c008dd6000990009aa80d111999aab9f0012501a233501930043574200460066ae880080508c8c8cccd5cd19b8735573aa004900011991091980080180118061aba150023005357426ae8940088c98c8050cd5ce00a80a00909aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180a9aba1500233500d014357426ae8940088c98c8064cd5ce00d00c80b89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6403666ae7007006c06406005c4d55cea80089baa00135742a00466a012eb8d5d09aba2500223263201533573802c02a02626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355017223233335573e0044a030466a02e66442466002006004600c6aae754008c014d55cf280118021aba200301213574200224464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900919ab9c01301201000f135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900819ab9c01101000e00d00c00b135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900619ab9c00d00c00a135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8028cd5ce00580500409baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c804ccd5ce00a00980880800780700680600589aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401866ae700340300280244d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200933573801401200e00c26aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401466ae7002c02802001c0184d55cea80089baa0012323333573466e1d40052002200c23333573466e1d40092000200c23263200633573800e00c00800626aae74dd5000a4c240029201035054310032001355006222533500110022213500222330073330080020060010033200135500522225335001100222135002225335333573466e1c005200000c00b1333008007006003133300800733500912333001008003002006003112200212212233001004003122002122001112323001001223300330020020014891c1c01d272b2805399427b08c19b1f2c396a3a4cbfa9f432223a796dae0001",
};
const MilestoneTokenAddress: Address = lucid.utils.validatorToAddress(MilestoneTokenScript);
const MilestoneTokenPolicyID: PolicyId = lucid.utils.mintingPolicyToId(MilestoneTokenScript);

// Define the Pooling Script
const poolScript: SpendingValidator = {
  type: "PlutusV2",
  script: "59133259132f0100003332332232323322332232323232323232323232323232323232323232323232323232323232323322323232323233322232323232323232323222222323253353232323232325335333573466e3c014d40348888888880240fc0f854cd54cd4c8c8c8d400488d4008894ccd4ccd406801cd40fc01800854cd40044114411841144118d54014888888888888014d4038888888888005405440fc4cd5ce24810f6265666f726520646561646c696e650003e15335333553023120013502150242333573466e3cd40388888888880240041000fcd5400c88888888888801040fc4cd5ce2491b6d757374206265207369676e656420627920617574686f726974790003e103e153355335353550032222222222220052232323500122350052253335333501b0060040021533500315335001104610471046104710463350133503b350102222222220010425017103f1335738920113646561646c696e6520686173207061737365640003e153355335333573466e1cccc0394008d4034888888888020015200103f03e103f133573892120646f65736e277420636f6e73756d6520616363657074616e636520746f6b656e0003e153355335333573466e1cccc0394008d4034888888888018015200103f03e103f133573892124646f65736e277420636f6e73756d652073747564656e742073746174757320746f6b656e0003e15335533533353027120012235002223500322533553335004153335002104521045210452153335003104521333573466ebc00800411c11884118854ccd400c41148411884cc0b40080044ccd54c0a448004d40bd40b88d400488ccd54c0b048004d40c940c48d400488ccd40048cc08d2000001223302400200123302300148000004cc08800c0044110c8d4004888888888888ccd54c0ac4800488d40088888d401088cd4008802094cd4ccd5cd19b8f001022055054133505633550580050060081008504e00a5003332233002335504430453374a900019aba0375200e66ae80dd4240006ec40f0cd4108cd54110050cd4108cd54110050d403c88888888800d410d410c0054101410440fc4cd5ce24922646f65736e27742063726561746520636f7272656374207363686f6c6172736869700003e1533553355335333573466e24ccc038ccc06c098ccd54c08c4800540688d4d400488004888800d4cd4c03c01084d400488d40048888ccd54c09448004894cd4cc068d4d40088800488880100184cd412400800440054120d4d402c8800888888888888803054cd4c03c01085854104c8cd54c08c480048d400488cd54118008cd54c098480048d400488cd54124008cdc124002002002002666aa604624002a03446a0024444006a0020240246a01a44444444400607e07c207e266ae71240119646f65736e27742077697468647261775570546f4c696d69740003e153355335303d5001103e103f103f133573892123636f6e74696e75696e67206f75747075747320646f6e2774206861766520646174756d0003e103e103f133573892012b73686f756c642072657475726e206578636573732041444120746f2074686520706f6f6c207363726970740003e103e103e103e103e15335300e0032135001223500122223500a2235002222222222222333553032120012235002222253353302b018004133505a0060051005505500a13263203a3357389201024c660003a1355001222222222222008135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40d80dcd5d0a80619a81b01b9aba1500b33503603835742a014666aa074eb940e4d5d0a804999aa81d3ae503935742a01066a06c07e6ae85401cccd540e8101d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd4129d69aba15002304c357426ae8940088c98c8138cd5ce02782702609aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa0049000119a81199a8253ad35742a00460986ae84d5d1280111931902719ab9c04f04e04c135573ca00226ea8004d5d09aba2500223263204a33573809609409026aae7940044dd50009aba1500533503675c6ae854010ccd540e80f08004d5d0a801999aa81d3ae200135742a004607c6ae84d5d1280111931902319ab9c047046044135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a008605c6ae84d5d1280211931901c19ab9c039038036375c00a6666ae68cdc39aab9d375400a9000101b11931901b19ab9c037036034103513263203533573892010350543500035135573ca00226ea8004888c8c8c004014c8004d540f088cd400520002235002225335333573466e3c0080240ec0e84c01c0044c01800cc8004d540ec88cd400520002235002225335333573466e3c00801c0e80e440044c01800c8d400488d4008888888888888cccd40349411494114941148ccd54c09048004cd40ac894cd40088400c400541148d4004894cd54cd4ccd5cd19b8f350022200235004220020430421333573466e1cd400888004d40108800410c10841084d412400c5412003448848cc00400c00888d400888d400c88c8cd40148cd401094cd4ccd5cd19b8f00200103703615003103620362335004203625335333573466e3c0080040dc0d85400c40d854cd400c854cd400884cd40088cd40088cd40088cd40088cc08000800480e48cd400880e48cc0800080048880e4888cd401080e48894cd4ccd5cd19b8700600303c03b15335333573466e1c0140080f00ec4cc04c01000440ec40ec40d054cd4004840d040d12210012223232323253335006215333500621533350082130044984c00d261533350072130044984c00d26100f100d1533350072130044984c00d261533350062130044984c00d26100e1533350052100c100d100b15333500521533350072130054984c011261533350062130054984c01126100e100c1533350062130054984c011261533350052130054984c01126100d2533350052153335007215333500721333500b00a002001161616100d153335006215333500621333500a009002001161616100c100b2533350042153335006215333500621333500a009002001161616100c1533350052153335005213335009008002001161616100b100a25333500321533350052153335005213335009008002001161616100b1533350042153335004213335008007002001161616100a100925333500221533350042153335004213335008007002001161616100a15333500321533350032133350070060020011616161009100812350012222222200711233333333001002225335333573466e1c0080040b40b0401c54cd4ccd5cd19b8900200102d02c1005100622333573466e200080040b40b088ccd5cd19b8900200102d02c22333573466e240080040b00b488ccd5cd19b8800200102c02d225335333573466e240080040b40b040044008894cd4ccd5cd19b8900200102d02c1002100122333573466e1c0080040ac0a8488800c488800848880044cd4040c004031409c888cd54c028480048d400488cd540b4008cd54c034480048d400488cd540c0008ccd40048cc0292000001223300b00200123300a00148000004cc01000800488cd54c020480048d400488cd540ac008ccd40048cd54c030480048d400488cd540bc008d5403400400488ccd5540200400080048cd54c030480048d400488cd540bc008d54030004004ccd55400c02c008004444888ccd54c010480054098cd54c020480048d400488cd540ac008d54024004ccd54c0104800488d4008894cd4ccd54c03448004d402d40388d400488cc028008014018400c4cd40a801000d409c004cd54c020480048d400488c8cd540b000cc004014c8004d540bc894cd40044d5402800c884d4008894cd4cc03000802044888cc0080280104c01800c008c8004d540a088448894cd40044008884cc014008ccd54c01c480040140100044484888c00c0104484888c00401048cd402888ccd400c88008008004d400488004c8004d540908844894cd40045408c884cd4090c010008cd54c01848004010004c8004d5408c88448894cd40044d400c88004884ccd401488008c010008ccd54c01c48004014010004448cc004894cd40084078400406c88ccd5cd19b8f00200101c01b2233700004002640026aa03e442444a66a0042a66a002203a44203c442a66a006203c442a66a6600e0080042666a60122400200e00600220402246600244a66a004200220320302466a00444666a006440040040026a0024400224424660020060042464460046eb0004c8004d5407088cccd55cf8009280d119a80c98021aba1002300335744004026464646666ae68cdc39aab9d5002480008cc8848cc00400c008c028d5d0a80118029aba135744a004464c6402666ae7005004c0444d55cf280089baa0012323232323333573466e1cd55cea8022400046666444424666600200a0080060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008c04cd5d0a80119a8068091aba135744a004464c6403066ae700640600584d55cf280089baa00135742a008666aa010eb9401cd5d0a8019919191999ab9a3370ea0029002118101aba135573ca00646666ae68cdc3a80124004464244460020086eb8d5d09aab9e500423333573466e1d400d20002122200323263201a33573803603403002e02c26aae7540044dd50009aba1500233500975c6ae84d5d1280111931900a19ab9c015014012135744a00226ae8940044d55cf280089baa0011335500175ceb44488c88c008dd5800990009aa80c91191999aab9f0022501823350173355019300635573aa004600a6aae794008c010d5d100180889aba100112232323333573466e1d4005200023501a3005357426aae79400c8cccd5cd19b87500248008940688c98c8044cd5ce00900880780709aab9d500113754002464646666ae68cdc3a800a400c46424444600800a600e6ae84d55cf280191999ab9a3370ea004900211909111180100298049aba135573ca00846666ae68cdc3a801a400446424444600200a600e6ae84d55cf280291999ab9a3370ea00890001190911118018029bae357426aae7940188c98c8044cd5ce00900880780700680609aab9d500113754002464646666ae68cdc39aab9d5002480008cc8848cc00400c008c014d5d0a8011bad357426ae8940088c98c8034cd5ce00700680589aab9e5001137540024646666ae68cdc39aab9d5001480008dd71aba135573ca004464c6401666ae7003002c0244dd5000919191919191999ab9a3370ea002900610911111100191999ab9a3370ea004900510911111100211999ab9a3370ea00690041199109111111198008048041bae35742a00a6eb4d5d09aba2500523333573466e1d40112006233221222222233002009008375c6ae85401cdd71aba135744a00e46666ae68cdc3a802a400846644244444446600c01201060186ae854024dd71aba135744a01246666ae68cdc3a8032400446424444444600e010601a6ae84d55cf280591999ab9a3370ea00e900011909111111180280418071aba135573ca018464c6402866ae7005405004804404003c0380340304d55cea80209aab9e5003135573ca00426aae7940044dd50009191919191999ab9a3370ea002900111999110911998008028020019bad35742a0086eb4d5d0a8019bad357426ae89400c8cccd5cd19b875002480008c8488c00800cc020d5d09aab9e500623263200d33573801c01a01601426aae75400c4d5d1280089aab9e500113754002464646666ae68cdc3a800a400446424460020066eb8d5d09aab9e500323333573466e1d400920002321223002003375c6ae84d55cf280211931900519ab9c00b00a008007135573aa00226ea8004488c8c8cccd5cd19b87500148010848880048cccd5cd19b875002480088d401cc018d5d09aab9e500423333573466e1d400d20002122200223263200b33573801801601201000e26aae7540044dd500089091118018021191999ab9a3370ea0029001100491999ab9a3370ea0049000100491931900319ab9c007006004003135573a6ea80052612001491035054310032001355009225335001100322132533553335350032222002100721007210071007100130040011220021220011122002122122330010040031122123300100300221222300200412122300200311220011123230010012233003300200200133512233333333300248811c85d9efa7117df5a2c8acf8152fa74904344e022f06a3f26d48b0280e0048811cb0a40aef423cfe3d56796536214216657046f05ff62307f15e6cad8a0048811c12cffb45b4187c7d2c7c650e4907300cb7aaf292556145e0773ad0530048811c368372cc013036b30067f3f69b1b23e61928a8d503508c41771ddc650048811c1c01d272b2805399427b08c19b1f2c396a3a4cbfa9f432223a796dae0048811c0edeb950414a821fc2dacf0905f2227381220c66c95a1b74bf117bf5004820212bd7d2004482c29bf79ab58888888888848ccccccccc00402802402001c01801401000c008800522011c019b5c6b029907aac8e873043d30535b5547c5f523eba7c0b8c6b55c0001",
};
const poolScriptAddress: Address = lucid.utils.validatorToAddress(poolScript);

// Define the Scholarship Script
const scholScript: SpendingValidator = {
  type: "PlutusV2",
  script: "59128d59128a01000033232333222332232323232323232323232332232332232323232323232323322323232323232323232323232323232323232323222323223223232533533322232323500523232253350081533553353302b500635012222222222009104113357389211e526566756e64206e6f74207369676e656420627920617574686f726974790004015335323232350012235002225333533350410073504200600215335001104710481047104835500822222222222200535013222222222001503e104113357389211c43616e277420726566756e64206265666f726520646561646c696e6500040104015335333573466e20cdc0000a40046a0244444444440040820802a66aa66a66056a00c0082082266ae71241174e6f74207369676e656420627920726563697069656e74000401533553355002104113357389211a4d696c6573746f6e6520746f6b656e206e6f74206275726e6564000401533553355005104113357389210f446561646c696e6520506173736564000401533553355335302c00721350363535001220012222003150342153355335302d0082135001223500122223500f223500222222222222233355303c120012235002222253353501822350062232335005233500425335333573466e3c00800419018c5400c418c818c8cd4010818c94cd4ccd5cd19b8f002001064063150031063153350032153350022133500223350022335002233500223305000200120662335002206623305000200122206622233500420662225335333573466e1c01800c1a41a054cd4ccd5cd19b8700500206906813306700400110681068106115335001210611061133504d0060051005504800a1326320233357389201024c660002310412215335001153355335323253335002153335001104621046210462153335002104621333573466ebc00800412011c8411c854ccd400841188411c84cc0c4008004d400c8888008c0c4c8d400488cdd2a400066ae80dd480119aba037500026ec409ccc10001ccdc0002240042088266ae712411e696e636f727265637420646174756d2c206f72206e6f7420696e6c696e6500043153353232333553035120013503d503c235001223335530381200135040503f23500122333500123304b4800000488cc1300080048cc12c005200000133029002001323355302e12001235001223355035002335530311200123500122335503800233350012330514800000488cc1480080048cc144005200000133029005001323355302e12001235001223355035002335530311200123500122335503800233704900080080080099a81a99aa81881d19a81a99aa81881d19b833501622222222200335016222222222002503650363500222220031044133573892010f696e636f72726563742076616c7565000431043221045104010411335738920122646f65736e27742077697468647261772066756e64696e6720636f72726563746c790004010401040104015335333573466e1ccdc0000a40046a0244444444440040820802a66aa66a66056a00c0082082266ae71241174e6f74207369676e656420627920726563697069656e74000401533553355002104113357389211a4d696c6573746f6e6520746f6b656e206e6f74206275726e656400040153355005104113357389210f446561646c696e6520506173736564000401040104010401333573466e1cc8c8c8c00400cc8004d5411888cd400520002235002225335333573466e3c00801c11c1184c0240044c01800cd4044888888888010d54010888888888888021200103f03e32001355043223350014800088d4008894cd4ccd5cd19b8f0020070440431001130060031353550012222222222220052232323500122350052253335333503d00600400215335003153350011043104410431044104333502d350393501022222222200103f503b135001220023333573466e1cd55cea803a400046606a6eb8d5d0a8039bad357426ae89401c8c98c8068cd5ce00d80d00c1999ab9a3370e6aae754011200023018357426aae7940148c98c8068cd5ce00d80d00c1999ab9a3370e6aae7540092000233221233001003002323232323232323232323232323333573466e1cd55cea8062400046666666666664444444444442466666666666600201a01801601401201000e00c00a00800600466a0320346ae854030cd4064068d5d0a80599a80c80d9aba1500a3335501d75ca0386ae854024ccd54075d7280e1aba1500833501902235742a00e666aa03a046eb4d5d0a8031919191999ab9a3370e6aae75400920002332212330010030023232323333573466e1cd55cea8012400046644246600200600466a05aeb4d5d0a80118171aba135744a004464c6406066ae700c40c00b84d55cf280089baa00135742a0046464646666ae68cdc39aab9d5002480008cd40f4cd40b5d69aba15002302e357426ae8940088c98c80c0cd5ce01881801709aab9e5001137540026ae84d5d1280111931901619ab9c02d02c02a135573ca00226ea8004d5d0a80299a80cbae35742a008666aa03a03e40026ae85400cccd54075d710009aba150023021357426ae8940088c98c80a0cd5ce01481401309aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226aae7940044dd50009aba150023011357426ae8940088c98c8068cd5ce00d80d00c080c89931900c99ab9c49010350543500019135573ca00226ea80044dd500089aab9e5001137540022464460046eb0004c8004d540d088cccd55cf80092811919a81118021aba1002300335744004024464646666ae68cdc39aab9d5002480008cc8848cc00400c008c028d5d0a80118029aba135744a004464c6402466ae7004c0480404d55cf280089baa0012323232323333573466e1cd55cea8022400046666444424666600200a0080060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008c04cd5d0a80119a8068091aba135744a004464c6402e66ae7006005c0544d55cf280089baa00135742a008666aa010eb9401cd5d0a8019919191999ab9a3370ea0029002118119aba135573ca00646666ae68cdc3a80124004464244460020086eb8d5d09aab9e500423333573466e1d400d20002122200323263201933573803403202e02c02a26aae7540044dd50009aba1500233500975c6ae84d5d1280111931900999ab9c014013011135744a00226ae8940044d55cf280089baa0011335500175ceb44488c88c008dd5800990009aa81891191999aab9f002250212335020335501c300635573aa004600a6aae794008c010d5d100180809aba100112232323333573466e1d400520002350223005357426aae79400c8cccd5cd19b87500248008940888c98c8040cd5ce00880800700689aab9d500113754002464646666ae68cdc3a800a400c46424444600800a600e6ae84d55cf280191999ab9a3370ea004900211909111180100298049aba135573ca00846666ae68cdc3a801a400446424444600200a600e6ae84d55cf280291999ab9a3370ea00890001190911118018029bae357426aae7940188c98c8040cd5ce00880800700680600589aab9d500113754002464646666ae68cdc39aab9d5002480008cc8848cc00400c008c014d5d0a8011bad357426ae8940088c98c8030cd5ce00680600509aab9e5001137540024646666ae68cdc39aab9d5001480008dd71aba135573ca004464c6401466ae7002c0280204dd5000919191919191999ab9a3370ea002900610911111100191999ab9a3370ea004900510911111100211999ab9a3370ea00690041199109111111198008048041bae35742a00a6eb4d5d09aba2500523333573466e1d40112006233221222222233002009008375c6ae85401cdd71aba135744a00e46666ae68cdc3a802a400846644244444446600c01201060186ae854024dd71aba135744a01246666ae68cdc3a8032400446424444444600e010601a6ae84d55cf280591999ab9a3370ea00e900011909111111180280418071aba135573ca018464c6402666ae7005004c04404003c03803403002c4d55cea80209aab9e5003135573ca00426aae7940044dd50009191919191999ab9a3370ea002900111999110911998008028020019bad35742a0086eb4d5d0a8019bad357426ae89400c8cccd5cd19b875002480008c8488c00800cc020d5d09aab9e500623263200c33573801a01801401226aae75400c4d5d1280089aab9e500113754002464646666ae68cdc3a800a400446424460020066eb8d5d09aab9e500323333573466e1d400920002321223002003375c6ae84d55cf280211931900499ab9c00a009007006135573aa00226ea8004488c8c8cccd5cd19b87500148010848880048cccd5cd19b875002480088d4088c018d5d09aab9e500423333573466e1d400d20002122200223263200a33573801601401000e00c26aae7540044dd50009191999ab9a3370ea0029001101211999ab9a3370ea0049000101211931900319ab9c007006004003135573a6ea80052612001491035054310022335530071200123500122335500e002333500123355300b1200123500122335501200235500d0010012233355500800d00200123355300b1200123500122335501200235500c00100133355500300800200111122233355300412001500f335530071200123500122335500e002355009001333553004120012235002225335333553012120013233501c223335003220020020013500122001123300122533500210261001023235001223300a00200500610031335013004003501000133553007120012350012232335500f003300100532001355027225335001135500a003221350022253353300c002008112223300200a0041300600300232001355020221122253350011002221330050023335530071200100500400111212223003004112122230010043200135501d22112253350011500d22133500e3004002335530061200100400122333573466e3c00800406406088d40088888888888894cd4ccd54c04c48005405894cd4ccd5cd19b8f00e0010250241350190011501800421025102323500122350022222222222223333500d25018250182501823335530141200150172350012253355335333573466e3cd400888008d4010880080a009c4ccd5cd19b8735002220013500422001028027102713501c0031501b00d112212330010030022122230020041221233001003002320013550162211222533500113500322001221333500522002300400233355300712001005004001112200212212233001004003133500622533500221003100150011212230020031122001488100112330012253350021001100c00b12335002223335003220020020013500122001122123300100300212223232323253335006215333500621533350082130044984c00d261533350072130044984c00d26101310111533350072130044984c00d261533350062130044984c00d261012153335005210101011100f15333500521533350072130054984c011261533350062130054984c01126101210101533350062130054984c011261533350052130054984c0112610112533350052153335007215333500721333500c00a0020011616161011153335006215333500621333500b0090020011616161010100f2533350042153335006215333500621333500b0090020011616161010153335005215333500521333500a008002001161616100f100e2533350032153335005215333500521333500a008002001161616100f1533350042153335004213335009007002001161616100e100d25333500221533350042153335004213335009007002001161616100e1533350032153335003213335008006002001161616100d100c121222300300412350012222222200722123300100300211233333333001002225335333573466e1c008004018014402454cd4ccd5cd19b890020010060051007100822333573466e2000800401801488ccd5cd19b8900200100600522333573466e2400800401401888ccd5cd19b88002001005006225335333573466e2400800401801440044008894cd4ccd5cd19b890020010060051002100122333573466e1c00800401000c488008488004488800c4888008488800488cdc00010008891918008009119801980100100099a8911999999998012451c85d9efa7117df5a2c8acf8152fa74904344e022f06a3f26d48b0280e0048811cb0a40aef423cfe3d56796536214216657046f05ff62307f15e6cad8a0048811c12cffb45b4187c7d2c7c650e4907300cb7aaf292556145e0773ad0530048811c368372cc013036b30067f3f69b1b23e61928a8d503508c41771ddc650048811c1c01d272b2805399427b08c19b1f2c396a3a4cbfa9f432223a796dae0048811c0edeb950414a821fc2dacf0905f2227381220c66c95a1b74bf117bf5004820212bd7d2004482c29bf79ab58888888888848ccccccccc00402802402001c01801401000c0088005",
};
const scholScriptAddress: Address = lucid.utils.validatorToAddress(scholScript);

/**
 * Mints an acceptance token, sending it directly to the student. Can only be succesfully called by the authority.
 * 
 * @param details The cardano address details of the student that the token is sent to
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function mintAcceptanceToken(
  details: AddressDetails,
): Promise<TxHash> {
  const PKH: string = details.paymentCredential.hash;
  const address : Address = details.address.bech32;
  const unit: Unit = acceptanceTokenPolicyID + PKH;

  const tx = await lucid
    .newTx()
    .mintAssets({ [unit]: 1n }, Data.void())
    .validTo(Date.now() + 100000)
    .attachMintingPolicy(acceptanceTokenScript)
    .payToAddress(address , { [unit]: 1n })
    .addSignerKey(PKH0)
    .complete();

  const signedTx = await tx.sign().complete();

  const txHash = await signedTx.submit();

  return txHash;
}

/**
 * Mints a student token, sending it directly to the student. Can only be succesfully called by the school.
 * 
 * @param details The cardano address details of the student that the token is sent to
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function mintStudentToken(
  details: AddressDetails,
): Promise<TxHash> {
  const PKH: string = details.paymentCredential.hash;
  const address : Address = details.address.bech32;
  const unit: Unit = studentTokenPolicyID + PKH;

  const tx = await lucid
    .newTx()
    .mintAssets({ [unit]: 1n }, Data.void())
    .validTo(Date.now() + 100000)
    .attachMintingPolicy(studentTokenScript)
    .payToAddress(address , { [unit]: 1n })
    .addSignerKey(PKH1)
    .complete();

  const signedTx = await tx.sign().complete();

  const txHash = await signedTx.submit();

  return txHash;
}

/**
 * Mints a milestone token, sending it directly to the student. Can only be succesfully called by the course provider (CP).
 * 
 * @param details The cardano address details of the student that the token is sent to
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function mintMilestoneToken(
  details: AddressDetails,
): Promise<TxHash> {
  const PKH: string = details.paymentCredential.hash;
  const address : Address = details.address.bech32;
  const unit: Unit = MilestoneTokenPolicyID + PKH;

  const tx = await lucid
    .newTx()
    .mintAssets({ [unit]: 1n }, Data.void())
    .validTo(Date.now() + 100000)
    .attachMintingPolicy(MilestoneTokenScript)
    .payToAddress(address , { [unit]: 1n })
    .addSignerKey(PKH2)
    .complete();

  const signedTx = await tx.sign().complete();

  const txHash = await signedTx.submit();

  return txHash;
}

/**
 * Makes a donation directly to the pooling contract. 
 * 
 * @param lovelace The amount to donate, in lovelace
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function donateToPool(
  lovelace: bigint,
): Promise<TxHash> {

  const tx = await lucid
    .newTx()
    .payToContract(poolScriptAddress, { inline : Data.void() }, { 'lovelace': lovelace } )
    .validTo(Date.now() + 100000)
    .complete();
  
  console.log(tx)
  const signedTx = await tx.sign().complete();

  const txHash = await signedTx.submit();

  return txHash;
}

// Define the type of the scholarship datum to match that of the plutus script. It contains the pkh of the student and their current milestone.
const ScholDatumSchema = Data.Object({
  pkh: Data.Bytes(),
  milestone: Data.Integer(),
});

type ScholDatum = Data.Static<typeof ScholDatumSchema>;
const ScholDatum = ScholDatumSchema as unknown as ScholDatum;

/**
 * Initialize a scholarship by burning an acceptanceToken and a studentToken. This transfers the quantity of lovelace for a scholarship from the pooling contract to the scholarship contract and labels it with the correct datum. Can only be successfully called by the student whose pkh is specified in the two tokens.
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function initialiseOwnScholarship() : Promise<TxHash> {
  const addr: Address = await lucid.wallet.address();
  const details: AddressDetails = getAddressDetails(addr);
  const PKH: string = details.paymentCredential.hash;
  const datum: ScholDatum = {
    pkh: PKH,
    milestone: 0n,
  };
  const acceptanceTokenUnit : Unit = acceptanceTokenPolicyID + PKH;
  const studentTokenUnit : Unit = studentTokenPolicyID + PKH;
  const lovelaceForSchol : bigint = 100000000n

  const utxoAtScript: UTxO[] = await lucid.utxosAt(poolScriptAddress);
  console.log("UTxOs at pooling script:")
  console.log(utxoAtScript)

  if( utxoAtScript && utxoAtScript.length > 0) {
    for (var UTxOStack: UTxO[] = [], acc: bigint = 0n, index = 0; // Pick out UTxOs at the script until we have enough for the scholarship. Note that we ask for at least 2 Ada more to guarantee we have enough leftover Ada to sent a change UTxO back to the pool.
      acc < lovelaceForSchol + 2000000n && index < utxoAtScript.length;
      acc += (utxoAtScript[index].assets)['lovelace'], index ++) { 
       UTxOStack.push(utxoAtScript[index])
      } 

    if (UTxOStack.length > 0 && acc >= lovelaceForSchol + 2000000n) {
      const tx = await lucid
        .newTx()
        .mintAssets({ [acceptanceTokenUnit]: -1n }, Data.void())
        .mintAssets({ [studentTokenUnit]: -1n }, Data.void())
        .validTo(Date.now() + 100000)
        .attachMintingPolicy(acceptanceTokenScript)
        .attachMintingPolicy(studentTokenScript)
        .payToContract(scholScriptAddress, { inline : Data.to(datum,ScholDatum) }, { 'lovelace': lovelaceForSchol })
        .collectFrom(UTxOStack, Data.to(PKH)) 
        .attachSpendingValidator(poolScript)
        .payToContract(poolScriptAddress, { inline : Data.void() }, { 'lovelace': acc - lovelaceForSchol })
        .complete();

      const signedTx = await tx.sign().complete();

      const txHash = await signedTx.submit();
    
      return txHash;
    }
    else return "Insufficient funds in pooling script"
  }
  else return "No UTxOs found at script."
}

/**
 * Withdraw the funding associated with completing a milestone. Burns a milestone token to do so. Can only be successfully called by the student whose pkh is specified in the token.
 * @param milestone The milestone that the student has just completed, and therefore wants to withdraw funding for. 
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function completeMilestone(
  milestone : bigint,
) : Promise<TxHash> {
  const addr: Address = await lucid.wallet.address();
  const details: AddressDetails = getAddressDetails(addr);
  const PKH: string = details.paymentCredential.hash;
  const prevDatum: ScholDatum = {
    pkh: PKH,
    milestone: milestone-1n,
  };
  const datum: ScholDatum = {
    pkh: PKH,
    milestone: milestone,
  };
  const milestoneTokenUnit : Unit = MilestoneTokenPolicyID + PKH;
  const lovelaceForSchol : bigint = 100000000n;
  const totalMilestones : bigint = 2n;

  const utxoAtScript: UTxO[] = await lucid.utxosAt(scholScriptAddress);

  console.log('UTxOs at Scholarship Script')
  console.log(utxoAtScript)

  const ourUTxO: UTxO = utxoAtScript.find((utxo) => utxo.datum == Data.to(prevDatum,ScholDatum));

  if ( ourUTxO ) {
    if ( milestone < totalMilestones ) {
      var tx = await lucid
      .newTx()
      .mintAssets({ [milestoneTokenUnit]: -1n }, Data.void())
      .attachMintingPolicy(MilestoneTokenScript)
      .validTo(Date.now() + 100000)
      .collectFrom([ourUTxO], Data.to(new Constr(0,[new Constr(0,[])]))) // I took this from the plutus.json file. How can I do this from false/true instead?
      .attachSpendingValidator(scholScript)
      .addSignerKey(PKH)
      .payToContract(scholScriptAddress, { inline : Data.to(datum,ScholDatum) }, { 'lovelace': lovelaceForSchol * (totalMilestones - milestone) / totalMilestones })
      .complete();
    }
    else {
      var tx = await lucid
      .newTx()
      .mintAssets({ [milestoneTokenUnit]: -1n }, Data.void())
      .attachMintingPolicy(MilestoneTokenScript)
      .validTo(Date.now() + 100000)
      .collectFrom([ourUTxO], Data.to(new Constr(0,[new Constr(0,[])]))) // I took this from the plutus.json file. How can I do this from false/true instead?
      .attachSpendingValidator(scholScript)
      .addSignerKey(PKH)
      .complete();
    }

    const signedTx = await tx.sign().complete();

    const txHash = await signedTx.submit();
  
    return txHash;
  }
  else return "No UTxO found matching your scholarship details"

}

/**
 * Allows the authority to claim back all UTxOs at the scholarship script after the deadline has passed.
 * 
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function deadlinePassedScholRefund(

) : Promise<TxHash> {

  const utxoAtScript: UTxO[] = await lucid.utxosAt(scholScriptAddress);

  console.log('UTxOs at Scholarship Script')
  console.log(utxoAtScript)

  if ( utxoAtScript && utxoAtScript.length > 0 ) {
    const tx = await lucid
    .newTx()
    .validFrom(Date.now() - 360000)
    .collectFrom(utxoAtScript, Data.to(new Constr(0,[new Constr(1,[])]))) // I took this from the plutus.json file. How can I do this from false/true instead?
    .attachSpendingValidator(scholScript)
    .addSignerKey(PKH0)
    .complete();

    const signedTx = await tx.sign().complete();

    const txHash = await signedTx.submit();
  
    return txHash;
  }
  else return "No UTxOs found at script"

}

/**
 * Allows the authority to claim back all UTxOs at the pooling script after the deadline has passed.
 * 
 * @returns The txHash of the submitted transaction. This can be checked against a blockchain explorer.
 */
export async function deadlinePassedPoolRefund(

  ) : Promise<TxHash> {
  
    const utxoAtScript: UTxO[] = await lucid.utxosAt(poolScriptAddress);
  
    console.log('UTxOs at Pool Script')
    console.log(utxoAtScript)
    console.log(Date.now())
  
    if ( utxoAtScript && utxoAtScript.length > 0) {
      const tx = await lucid
      .newTx()
      .validFrom(Date.now() - 360000) //HELP: What is a good time period to use here?
      .collectFrom(utxoAtScript, Data.to(PKH0))
      .attachSpendingValidator(poolScript)
      .addSignerKey(PKH0)
      .complete();
  
      const signedTx = await tx.sign().complete();
  
      const txHash = await signedTx.submit();
    
      return txHash;
    }
    else return "No UTxOs found at script"
  
  }

// Below are the commands required to test the full user flow of the contract. 
// Uncomment one at a time and run this file with: deno run -A lucid_functions.ts

// Mint and send acceptance token
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 0 });
// console.log(await mintAcceptanceToken(details4));

// Mint and send student token
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 1 });
// console.log(await mintStudentToken(details4));

// Donate 200 Ada to PoolScript
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 3})
// console.log(await donateToPool(200000000n))

// Initialize Scholarship Using Pool Funds
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 4})
// console.log(await initialiseOwnScholarship())

// Mint and send milestone token
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 2 });
// console.log(await mintMilestoneToken(details4));

// Complete Milestone 1 and withdraw funding
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 4})
// console.log(await completeMilestone(1n))

// Mint and send milestone token
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 2 });
// console.log(await mintMilestoneToken(details4));

// Complete Milestone 2 and withdraw funding
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 4})
// console.log(await completeMilestone(2n))


// Authority Refund from schol script after deadline passed
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 0})
// console.log(await deadlinePassedScholRefund())

// Authority Refund from pool script after deadline passed
// lucid.selectWalletFromSeed(secretSeed, { accountIndex: 0})
// console.log(await deadlinePassedPoolRefund())
